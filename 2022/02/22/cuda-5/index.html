<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="CUDA 11æ–°ç‰¹æ€§ï¼ŒAmpereæ¶æ„æ”¯æŒï¼ŒAsynchronous copyå¼‚æ­¥æ•°æ®æ‹·è´">
<meta property="og:type" content="article">
<meta property="og:title" content="CUDAå­¦ä¹ éšè®°5 Asynchronous copy cp.async">
<meta property="og:url" content="http://example.com/2022/02/22/cuda-5/index.html">
<meta property="og:site_name" content="é‚µå¤§å®çš„å­¦ä¹ Blog">
<meta property="og:description" content="CUDA 11æ–°ç‰¹æ€§ï¼ŒAmpereæ¶æ„æ”¯æŒï¼ŒAsynchronous copyå¼‚æ­¥æ•°æ®æ‹·è´">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/02/22/cuda-5/LDGSTS%20access%20and%20bypass.png">
<meta property="article:published_time" content="2022-02-22T13:51:12.000Z">
<meta property="article:modified_time" content="2022-06-28T14:18:33.319Z">
<meta property="article:author" content="Jiang Shao">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/02/22/cuda-5/LDGSTS%20access%20and%20bypass.png">

<link rel="canonical" href="http://example.com/2022/02/22/cuda-5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>CUDAå­¦ä¹ éšè®°5 Asynchronous copy cp.async | é‚µå¤§å®çš„å­¦ä¹ Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">é‚µå¤§å®çš„å­¦ä¹ Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æœ€çˆ±ä¸¥å°è·³</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/22/cuda-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Jiang Shao">
      <meta itemprop="description" content="WeChat: shaojiang9650<br>Email: shao_study@163.com">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="é‚µå¤§å®çš„å­¦ä¹ Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CUDAå­¦ä¹ éšè®°5 Asynchronous copy cp.async
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-22 21:51:12" itemprop="dateCreated datePublished" datetime="2022-02-22T21:51:12+08:00">2022-02-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-28 22:18:33" itemprop="dateModified" datetime="2022-06-28T22:18:33+08:00">2022-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CUDA%E5%AD%A6%E4%B9%A0%E9%9A%8F%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">CUDAå­¦ä¹ éšè®°</span></a>
                </span>
            </span>

          
            <div class="post-description">CUDA 11æ–°ç‰¹æ€§ï¼ŒAmpereæ¶æ„æ”¯æŒï¼ŒAsynchronous copyå¼‚æ­¥æ•°æ®æ‹·è´</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="CUDAå­¦ä¹ éšè®°5-Asynchronous-copy-cp-async"><a href="#CUDAå­¦ä¹ éšè®°5-Asynchronous-copy-cp-async" class="headerlink" title="CUDAå­¦ä¹ éšè®°5 Asynchronous copy cp.async"></a>CUDAå­¦ä¹ éšè®°5 Asynchronous copy cp.async</h1><p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#data-movement-and-conversion-instructions-asynchronous-copy">1. PTX (Parallel Thread Execution) ISA (Instruction Set Architecture)</a><br><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-binary-utilities/index.html">2. CUDA Binary Utilities (ç”¨äºæŸ¥è¯¢SASS code)</a></p>
<p>An asynchronous copy operation copies data from one state space to another asynchronously <strong>without blocking the executing thread</strong>.<br>Initiation of an asynchronous copy operation simply dispatches the copy operation from the source memory location to the destination memory location.<br>å¼‚æ­¥æ‹·è´ï¼Œä¸é˜»å¡çº¿ç¨‹ï¼Œä»…å‘èµ·ä¸€ä¸ªå¼‚æ­¥æ‹·è´è¯·æ±‚ã€‚</p>
<p>There are two ways to wait for the completion of an asynchronous copy operation:<br>ä¸¤ç§æ–¹å¼ç­‰å¾…å¼‚æ­¥æ‹·è´æ“ä½œå®Œæˆï¼š</p>
<ol>
<li>ä½¿ç”¨<strong>cp.async-groups</strong><br>a. Initiate asynchronous copy operations.<br>b. Commit copy operations into a cp.async-group. <strong>Using cp.async.commit_group</strong><br>c. Wait for cp.async-group to complete the copy. <strong>Using cp.async.wait_group</strong><br>d. Once the cp.async-group completes, the writes performed by the copy operation in that cp.async-group are made <strong>visible to the thread that initiated the copy operations</strong>.</li>
<li>ä½¿ç”¨<strong>mbarrier</strong>å¯¹è±¡<br>a. Initiate asynchronous copy operations.<br>b. Make an mbarrier object track the asynchronous copy operations.<br>c. Wait for the mbarrier object to complete the phaseé˜¶æ®µ using mbarrier.test_wait.<br>d. Once mbarrier.test_wait returns True, the writes performed by the copy operation are made <strong>visible to all the threads which waited on the mbarrier object</strong>.</li>
</ol>
<p>A sequence of asynchronous copy operations initiated by a thread can be batched into a <strong>per-thread group</strong> referred to as cp.async-group.<br>ç”±å•ä¸ªçº¿ç¨‹å‘å‡ºçš„ä¸€ç³»åˆ—å¼‚æ­¥æ‹·è´æ“ä½œå¯ä»¥æ‰“åŒ…ä¸ºa per-thread groupï¼Œç§°ä¸ºcp.async-groupã€‚</p>
<p>A commit operation creates <strong>a cp.async-group containing all prior asynchronous copy operations initiated by the executing thread</strong> but none of the asynchronous copy operations following the commit operation. A committed asynchronous copy operation belongs to a single cp.async-group.<br>åˆ›å»ºä¸€ä¸ªcp.async-groupå°†åŒ…å«æ‰€æœ‰ç”±æœ¬çº¿ç¨‹å‘å‡ºçš„ä¹‹å‰çš„å¼‚æ­¥æ‹·è´æ“ä½œï¼Œä¸åŒ…æ‹¬ä¹‹åçš„ã€‚æ¯ä¸ªå¼‚æ­¥æ‹·è´æ“ä½œä»…å±äºä¸€ä¸ªcp.async-groupã€‚<br>ç”±äºæ‰§è¡Œåˆ°cp.async-groupæ—¶ï¼Œå…¶ä¹‹å‰çš„æ‰€æœ‰å¼‚æ­¥æ‹·è´æ“ä½œå‡å·²è¢«å¯¹åº”cp.async-groupæ”¶å½•ï¼Œå› æ­¤ä¸‹ä¸€ä¸ªcp.async-groupä»…åŒ…å«ä¸¤æ¡cp.async-groupä¹‹é—´çš„æ–°å‘å‡ºçš„å¼‚æ­¥æ‹·è´æ“ä½œï¼Œæ‰€ä»¥è¯´æ¯ä¸ªå¼‚æ­¥æ‹·è´æ“ä½œä»…å±äºä¸€ä¸ªcp.async-groupã€‚</p>
<p>When a cp.async-group completes, all the asynchronous copy operations belonging in that group are complete and the executing thread that initiated copy operations can read copied results. All cp.async-groups committed by an executing thread always complete in the order in which they were committed. There is no ordering between asynchronous copy operations within a cp.async-group.<br>å½“cp.async-groupå®Œæˆæ—¶ï¼Œå…¶æ‰€åŒ…å«çš„æ‰€æœ‰å¼‚æ­¥æ‹·è´æ“ä½œå‡å·²å®Œæˆï¼Œå‘å‡ºå¼‚æ­¥æ‹·è´è¯·æ±‚çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹ï¼‰å¯ä»¥å®‰å…¨è¯»å–æ‹·è´ç»“æœã€‚çº¿ç¨‹å‘å°„çš„cp.async-groupsæ°¸è¿œæŒ‰ç…§é¡ºåºå®Œæˆï¼Œè€Œcp.async-groupä¸­åŒ…å«çš„å¼‚æ­¥æ‹·è´æ“ä½œçš„æ‰§è¡Œé¡ºåºæ˜¯éšæœºçš„ã€‚</p>
<p>Writes performed by an asynchronous copy operation are visible to the thread that initiated the asynchronous copy operation only after the cp.async-group completes or mbarrier object tracking the asynchronous copy has completed the phase.<br>ä»…å½“cp.async-groupå®Œæˆ or mbarrierè¿½è¸ªåˆ°å¼‚æ­¥æ‹·è´å®Œæˆï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½å®‰å…¨è¯»å–ç”±å½“å‰çº¿ç¨‹å‘å‡ºçš„å¼‚æ­¥æ‹·è´æ“ä½œå†™å…¥çš„æ•°æ®ï¼ˆæ•°æ®å¯è§ï¼‰ã€‚</p>
<p>Once an asynchronous copy operation is initaited, modifiying the source memory location or reading from the destination memory location before the asynchronous copy operation completes, will cause unpredictable results.<br>ä¸€æ—¦ä¸€ä¸ªå¼‚æ­¥æ‹·è´æ“ä½œè¢«å‘èµ·ï¼Œä¸ç­‰å¾…å¼‚æ­¥æ‹·è´æ“ä½œå®Œæˆå°± ä¿®æ”¹æºå†…å­˜åœ°å€ä¸­çš„æ•°æ® or å°±è¯»å–ç›®æ ‡å†…å­˜åœ°å€ä¸­çš„æ•°æ®ï¼Œå°†ä¼šäº§ç”Ÿunpredictable resultsã€‚</p>
<h4 id="cp-async"><a href="#cp-async" class="headerlink" title="cp.async"></a>cp.async</h4><p>Initiates an asynchronous copy operation from one state space to another.<br>å‘èµ·ä¸€ä¸ªå¼‚æ­¥æ‹·è´æ“ä½œã€‚<br>Operand src specifies a location in the global state space and dst specifies a location in the shared state space.<br>å¼‚æ­¥æ‹·è´åªèƒ½æ˜¯ä»global memæ‹·è´åˆ°shared memã€‚<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cp.async.ca.shared.global&#123;.level::cache_hint&#125;&#123;.level::prefetch_size&#125;</span><br><span class="line">                         [dst], [src], cp-size&#123;, src-size&#125;&#123;, cache-policy&#125; ;</span><br><span class="line">cp.async.cg.shared.global&#123;.level::cache_hint&#125;&#123;.level::prefetch_size&#125;</span><br><span class="line">                         [dst], [src], <span class="number">16</span>&#123;, src-size&#125;&#123;, cache-policy&#125; ;</span><br><span class="line">cp.async.ca.shared.global&#123;.level::cache_hint&#125;&#123;.level::prefetch_size&#125;</span><br><span class="line">                         [dst], [src], cp-size&#123;, ignore-src&#125;&#123;, cache-policy&#125; ;</span><br><span class="line">cp.async.cg.shared.global&#123;.level::cache_hint&#125;&#123;.level::prefetch_size&#125;</span><br><span class="line">                         [dst], [src], <span class="number">16</span>&#123;, ignore-src&#125;&#123;, cache-policy&#125; ;</span><br></pre></td></tr></table></figure><br>The <strong>.cg</strong> qualifier indicates caching of data only at global level cache L2 and not at L1 whereas <strong>.ca</strong> qualifier indicates caching of data at all levels including L1 cache. Cache operator are treated as performance hints only.<br><strong>.cg</strong>è¡¨ç¤ºä»…ç”¨L2 cacheï¼Œæ•°æ®ä¼ è¾“ç»•è¿‡L1 cacheä¸registerã€‚å¯¹åº”LDGSTS.BYPASSã€‚<br><strong>.ca</strong>è¡¨ç¤ºåŒæ—¶ä½¿ç”¨L1 cacheä¸L2 cacheï¼Œæ•°æ®ä¼ è¾“ä»…ç»•è¿‡registerã€‚å¯¹åº”LDGSTS.ACCESSã€‚<br>è¿™ä¿©æ ‡è¯†ç¬¦åªæ˜¯å¯¹ç¼–è¯‘å™¨çš„å»ºè®®ï¼Œå…·ä½“ç”¨ä¸ç”¨è¦çœ‹ç¼–è¯‘å™¨çš„æ„æ€ã€‚å®é™…ä¸Šå…·ä½“ä½¿ç”¨å“ªç§å–å†³äºä¼ è¾“æ•°æ®çš„å¤§å°ä¸å¯¹é½æ–¹å¼ã€‚4 Bytes-&gt;accessï¼Œ16 Bytes-&gt;bypassã€‚</p>
<p>Operand cp-size is an integer constant which specifies the size of data in bytes to be copied to the destination dst. cp-size can only be 4, 8 and 16.<br>cp-sizeæŒ‡å®šäº†ä¼ è¾“æ•°æ®çš„å¤§å°ï¼ˆin bytesï¼‰ï¼Œå¯ä»¥æ˜¯4ã€8ã€16ï¼Œå¯ä»¥çœ‹åˆ°cp-sizeæœ€å°æ˜¯4ï¼Œè€Œ.cgæŒ‡ä»¤cp-sizeç›´æ¥æŒ‡å®šä¸º16ï¼Œæ­£å¥½ç¬¦åˆä¸Šé¢çš„è¯´æ³•ã€‚</p>
<center><img src="/2022/02/22/cuda-5/LDGSTS%20access%20and%20bypass.png" width="100%" height="100%"><font color="#708090" size="2">Two types of LDGSTS: access and bypass.</font></center>

<p>Instruction cp.async allows optionally specifying a 32-bit integer operand <strong>src-size</strong>. Operand src-size represents the size of the data in bytes to be copied from src to dst and must be less than <strong>cp-size</strong>. In such case, remaining bytes in destination dst are filled with zeros. Specifying src-size larger than cp-size results in undefined behavior.<br>src-sizeï¼ŒæŒ‡å®šæ‹·è´æºæ•°æ®å¤§å°ï¼Œå¿…é¡»æ¯”cp-sizeå°ï¼Œå¦åˆ™undefined behaviorã€‚å¾ˆç®€ç­”ï¼Œå¦‚æœæ¯”cp-sizeå¤§ï¼Œåˆ™æ‹·è´æ•°æ®ä¸å®Œæ•´ï¼Œå†è¯»å–è‚¯å®šä¸å¯¹ã€‚cp-sizeæ¯”src-sizeå¤šå‡ºæ¥çš„éƒ¨ä»½åœ¨dstä¸­ä¼šè¢«å¡«å……0ã€‚</p>
<p>The optional and non-immediate predicate argument <strong>ignore-src</strong> specifies whether the data from the source location src should be ignored completely. If the source data is ignored then zeros will be copied to destination dst. If the argument ignore-src is not specified then it defaults to False.<br>æŒ‡å®šæ˜¯å¦å¿½ç•¥scrä¸­çš„æ•°æ®ï¼Œå¦‚æœç½®ä¸ºtrueï¼Œåˆ™å‘dstä¸­æ‹·è´0ã€‚é»˜è®¤ä¸ºfalseã€‚</p>
<p>The mandatory(å¼ºåˆ¶çš„) <strong>.async</strong> qualifier indicates that the cp instruction will <strong>initiate the memory copy operation asynchronously</strong> and <strong>control will return to the executing thread before the copy operation is complete</strong>. The executing thread can then use <strong>cp.async.wait_all</strong> or <strong>cp.async.wait_group</strong> or <strong>mbarrier instructions</strong> to wait for completion of the asynchronous copy operation. No other synchronization mechanisms described in Memory Consistency Model can be used to guarantee the completion of the asynchronous copy operations.<br>ä¸‰ç§ç”¨æ¥åŒæ­¥å¼‚æ­¥æ•°æ®ä¼ è¾“æ“ä½œçš„æ–¹æ³•ï¼š<br><strong>cp.async.wait_all</strong> or <strong>cp.async.wait_group</strong> or <strong>mbarrier instructions</strong></p>
<p>There is no ordering guarantee between two cp.async operations if they are not explicitly synchronized using cp.async.wait_all or cp.async.wait_group or mbarrier instructions.<br>å¦‚æœæ²¡æœ‰æ˜¾å¼åŒæ­¥ï¼Œä¸¤ä¸ªcp.asyncä¹‹é—´æ²¡æœ‰é¡ºåºä¿è¯ã€‚</p>
<p>The <strong>.level::prefetch_size</strong> qualifier is a hint to <strong>fetch additional data of the specified size into the respective cache level</strong>.The sub-qualifier prefetch_size can be set to either of 64B, 128B, 256B thereby allowing the prefetch size to be 64 Bytes, 128 Bytes or 256 Bytes respectively.</p>
<p>The qualifier .level::prefetch_size may only be used with .global state space and with generic addressing where the address points to .global state space. If the generic address does not fall within the address window of the global memory, then the prefetching behavior is undefined.</p>
<p>The .level::prefetch_size qualifier is treated as a performance hint only.</p>
<p>When the optional argument <strong>cache-policy</strong> is specified, the qualifier <strong>.level::cache_hint</strong> is required. The 64-bit operand cache-policy specifies <strong>the cache eviction policy</strong> that may be used during the memory access.</p>
<p>The qualifier .level::cache_hint is only supported for .global state space and for generic addressing where the address points to the .global state space.</p>
<p>cache-policy is a hint to the cache subsystem and may not always be respected. It is treated as a performance hint only, and does not change the memory consistency behavior of the program.</p>
<p>.level::prefetch_sizeä¸.level::cache_hintéƒ½æ˜¯ä¸ç¼“å­˜ç›¸å…³çš„qualifierã€‚éƒ½æ˜¯hints to the compilerï¼Œå¹¶ä¸ä¸€å®šè¢«ç¼–è¯‘å™¨æ‰€é‡‡çº³ã€‚ç”±äºæ˜¯ç¼“å­˜ç›¸å…³çš„ï¼Œæ‰€ä»¥æ“ä½œå¯¹è±¡åœ°å€å¿…é¡»åœ¨global memoryä¸­ï¼Œå¦åˆ™ä¼šå¯¼è‡´undefined behavior.<br>.level::prefetch_sizeç”¨äºåœ¨ç¼“å­˜ä¸­é™¤äº†è¦æ‹·è´çš„æ•°æ®ä¹‹å¤–ï¼Œé¢å¤–fetchä¸€å®šå¤§å°çš„æ•°æ®åˆ°å¯¹åº”cacheä¸­ï¼Œç”¨äºå¢åŠ ç¼“å­˜å‘½ä¸­ç‡ï¼Œå‡å°‘ä»device memoryä¸­è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚<br>.level::cache_hintç”¨äºcache-policyæŒ‡å®šæ—¶ï¼Œç”¨äºæŒ‡å®šç¼“å­˜æ¸…é™¤ç­–ç•¥ï¼Œå¦‚ä½•ä½¿ç”¨ç¼“å­˜ã€‚</p>
<h4 id="cp-async-commit-group"><a href="#cp-async-commit-group" class="headerlink" title="cp.async.commit_group"></a>cp.async.commit_group</h4><p>Commits all prior initiated but uncommitted cp.async instructions into a cp.async-group.<br>å°†ä¹‹å‰çš„æœªè¢«commitçš„cp.async commitåˆ°ä¸€ä¸ªcp.async-groupã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp.async.commit_group;</span><br></pre></td></tr></table></figure>
<p>è¿™æ¡PTX codeæ‰€äº§ç”Ÿçš„SASS codeå°±æ˜¯<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDGDEPBAR <span class="comment">//Global Load Dependency Barrier</span></span><br></pre></td></tr></table></figure><br>ä¼šå¯¼è‡´ä¸€ä¸ªå¾ˆå¤§çš„stall long scoreboardã€‚</p>
<p><strong>cp.async.commit_group</strong> instruction creates a new cp.async-group <strong>per thread</strong> and batches all prior cp.async instructions <strong>initiated by the executing thread but not committed to any cp.async-group</strong> into the new cp.async-group. If there are no uncommitted cp.async instructions then cp.async.commit_group results in an empty cp.async-group.</p>
<p>An executing thread can wait for the completion of all cp.async operations in a cp.async-group using cp.async.wait_group.</p>
<p>There is no memory ordering guarantee provided between any two cp.async operations within the same cp.async-group. So two or more cp.async operations within a cp.async-group copying data to the same location results in undefined behavior.<br>åœ¨åŒä¸€ä¸ªcp.async-groupä¸­çš„cp.asyncæ²¡æœ‰é¡ºåºä¿è¯ï¼Œå› æ­¤åœ¨åŒä¸€cp.async-groupä¸­å¯¹åŒä¸€åœ°å€çš„cp.asyncä¼šå¯¼è‡´undefined behaviorã€‚</p>
<h4 id="cp-async-wait-group-cp-async-wait-all"><a href="#cp-async-wait-group-cp-async-wait-all" class="headerlink" title="cp.async.wait_group/cp.async.wait_all"></a>cp.async.wait_group/cp.async.wait_all</h4><p>Wait for completion of prior asynchronous copy operations.<br>ç­‰å¾…å…ˆå‰çš„å¼‚æ­¥æ‹·è´æ“ä½œå®Œæˆã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp.async.wait_group N;</span><br><span class="line">cp.async.wait_all;</span><br></pre></td></tr></table></figure>
<p><strong>cp.async.wait_group</strong> instruction will cause executing thread to wait till <strong>only N or fewer of the most recent cp.async-groups are pending</strong> and <strong>all the prior cp.async-groups committed by the executing threads are complete</strong>. For example, when N is 0, the executing thread waits on all the prior cp.async-groups to complete. Operand N is an integer constant.</p>
<p>cp.async.wait_group N; ç­‰å¾…execution threadç›´åˆ°è¿˜å‰© N ä¸ªæˆ–æ›´å°‘ä¸ª<strong>æœ€è¿‘çš„</strong>cp.async-groupè¿˜åœ¨è¿›è¡Œä¸­ã€æœªå®Œæˆã€‚ç”±äºcp.async-groupæŒ‰ç…§è¢«commitçš„é¡ºåºä¾æ¬¡å®Œæˆï¼Œå› æ­¤å…ˆå‘å‡ºçš„å¿…å…ˆå®Œæˆï¼Œç­‰å¾…æŒ‡ä»¤ç­‰å¾…åå‘å‡ºçš„cp.async-groupã€‚</p>
<p>cp.async.wait_all; ç­‰å¾…execution threadå…ˆå‰çš„æ‰€æœ‰cp.asyncéƒ½å®Œæˆã€‚ä¹Ÿå°±æ˜¯ç­‰ä»·äºcommitä¸€ä¸ªcp.async-groupç„¶åé©¬ä¸Šç­‰å¾…æ‰€æœ‰å…ˆå‰çš„cp.async-groupå®Œæˆã€‚<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp.async.commit_group; <span class="comment">//å°†ä»æœªè¢«commitçš„cp.async commitåˆ°ä¸€ä¸ªcp.async-groupä¸­</span></span><br><span class="line">cp.async.wait_group <span class="number">0</span>; <span class="comment">//ç­‰å¾…æ‰€æœ‰å…ˆå‰çš„cp.async-groupå®Œæˆ</span></span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœNä¸º0ï¼Œé‚£ä¹ˆè¿™æ¡PTX codeæ‰€äº§ç”Ÿçš„SASS codeå°±æ˜¯<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEPBAR.LE SB0, <span class="number">0x0</span> ;<span class="comment">//ç­‰å¾…ç›´åˆ°SB0çš„è®¡æ•°é™è‡³0</span></span><br></pre></td></tr></table></figure><br>DEPBARçš„ä½œç”¨æ˜¯ç­‰å¾…ï¼Œç›´åˆ°æŸä¸€Scoreboardçš„è®¡æ•°å°äºç‰¹å®šå€¼ã€‚ï¼ˆæ¯”å¦‚DEPBAR.LE SB5, 0x6 ;è¡¨ç¤ºstallç›´è‡³ç¬¬5ä¸ªScoreboardçš„å€¼é™åˆ°6æˆ–ä»¥ä¸‹ï¼‰</p>
<p>SBæŒ‡çš„å°±æ˜¯scoreboardã€‚è®°å½•cp.async-groupçš„æ•°é‡ï¼ˆä¸€ä¸ªcounterï¼‰ä¸æ¯ä¸ªcp.async-groupæ‰€å¯¹åº”çš„cp.async (LDGSTS)çš„æ•°é‡ã€‚æ¯æ¬¡ä¸€ä¸ªcp.async-groupå®Œæˆï¼Œcounter - 1ã€‚counterçš„æ•°é‡åˆšå¥½å¯¹åº”Nçš„å€¼ã€‚<br>N æŒ‡æ˜çº¿ç¨‹ç­‰å¾…ç›´åˆ°åªæœ‰ N æˆ–æ›´å°‘ä¸ªcp.async-groupæœªå®Œæˆæ‰ç»§ç»­ã€‚å¦‚æœæ˜¯0ï¼Œé‚£ä¹ˆå°±æ˜¯ç­‰å¾…åªæœ‰0ä¸ªæœªå®Œæˆï¼Œä»£è¡¨ç­‰å¾…æ‰€æœ‰çš„cp.async-groupå®Œæˆã€‚ç”±äºcp.async-groupæ˜¯ä¿æŒå‘å°„é¡ºåºçš„ï¼Œå› æ­¤Nç­‰å¾…çš„æ°¸è¿œæ˜¯å€’æ•°çš„Nä¸ªcp.async-groupï¼Œå°±æ˜¯æœ€è¿‘å‘å°„çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example of .wait_all:</span></span><br><span class="line">cp.async.ca.shared.global [shrd1], [gbl1], <span class="number">4</span>;</span><br><span class="line">cp.async.cg.shared.global [shrd2], [gbl2], <span class="number">16</span>;</span><br><span class="line">cp.async.wait_all;  <span class="comment">// waits for all prior cp.async to complete</span></span><br></pre></td></tr></table></figure>
<p>cp.async.wait_allç­‰å¾…å‰é¢æ‰€æœ‰çš„cp.asyncå®Œæˆã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example of .wait_group :</span></span><br><span class="line">cp.async.ca.shared.global [shrd3], [gbl3], <span class="number">8</span>;</span><br><span class="line">cp.async.commit_group;  <span class="comment">// End of group 1</span></span><br><span class="line"></span><br><span class="line">cp.async.cg.shared.global [shrd4], [gbl4], <span class="number">16</span>;</span><br><span class="line">cp.async.commit_group;  <span class="comment">// End of group 2</span></span><br><span class="line"></span><br><span class="line">cp.async.cg.shared.global [shrd5], [gbl5], <span class="number">16</span>;</span><br><span class="line">cp.async.commit_group;  <span class="comment">// End of group 3</span></span><br><span class="line"></span><br><span class="line">cp.async.wait_group <span class="number">1</span>;  <span class="comment">// waits for group 1 and group 2 to complete</span></span><br></pre></td></tr></table></figure>
<p>cp.async.wait_group 1 å…è®¸æœ‰ä¸€ä¸ªcp.async-groupæœªå®Œæˆï¼ŒæŒ‰ç…§é¡ºåºï¼Œæ­¤æ¡æŒ‡ä»¤ç­‰å¾…group 1 and 2å®Œæˆã€‚</p>
<p>Writes performed by cp.async operations are made <strong>visible to the executing thread</strong> only after :</p>
<ol>
<li>The completion of cp.async.wait_all or</li>
<li>The completion of cp.async.wait_group on the cp.async-group in which the cp.async belongs to or</li>
<li>mbarrier.test_wait returns True on an mbarrier object which is tracking the completion of the cp.async operation.<br>ä¸‰ç§æƒ…å†µä¸‹ï¼Œç”±cp.asyncå†™å…¥çš„æ•°æ®å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚cp.async.wait_allå®Œæˆäº†ï¼Œä»£è¡¨æ­¤å¤„ä¹‹å‰æ‰€æœ‰çš„cp.asyncéƒ½å·²å®Œæˆã€‚cp.asyncæ‰€åœ¨çš„cp.async-groupå®Œæˆäº†ï¼Œä½¿ç”¨cp.async.wait_groupå®ç°ã€‚è¿½è¸ªæ­¤cp.asyncçš„mbarrierçš„mbarrier.test_waitè¿”å›trueã€‚</li>
</ol>
<p>There is no ordering between two cp.async operations that are not synchronized with cp.async.wait_all or cp.async.wait_group or mbarrier objects.</p>
<p><strong>cp.async.wait_group and cp.async.wait_all does not provide any ordering and visibility guarantees for any other memory operation apart from cp.async.</strong><br>cp.async.wait_group and cp.async.wait_allä»…å½±å“cp.asyncçš„é¡ºåºï¼Œå…¶ä»–å†…å­˜æ“ä½œä¸æ­¤æ— å…³ã€‚å¾ˆå®¹æ˜“çœ‹å‡ºå˜›ã€‚å‰ç¼€éƒ½æ˜¯cp.async.*ï¼Œæ˜æ˜¾å°±æ˜¯è¿™ä¸ªä¸“ç”¨çš„ã€‚è¿™é‡Œæ²¡è¯´mbarrierï¼Œè¯´æ˜è¿™ç©åº”æ˜¯å¯¹æ‰€æœ‰å†…å­˜æ“ä½œéƒ½æœ‰æ•ˆçš„ï¼Œæ˜¯åŒæ­¥éšœç¢ã€‚</p>
<h3 id="ä¸Julien-Demouth-60-x6a-100-x65-x6d-111-x75-x74-x68-x40-110-x76-105-100-105-97-46-x63-x6f-x6d-gt-çš„é‚®ä»¶å¾€æ¥"><a href="#ä¸Julien-Demouth-60-x6a-100-x65-x6d-111-x75-x74-x68-x40-110-x76-105-100-105-97-46-x63-x6f-x6d-gt-çš„é‚®ä»¶å¾€æ¥" class="headerlink" title="ä¸Julien Demouth &#60;&#x6a;&#100;&#x65;&#x6d;&#111;&#x75;&#x74;&#x68;&#x40;&#110;&#x76;&#105;&#100;&#105;&#97;&#46;&#x63;&#x6f;&#x6d;&gt;çš„é‚®ä»¶å¾€æ¥"></a>ä¸Julien Demouth <a href="&#x6d;&#97;&#x69;&#108;&#116;&#x6f;&#58;&#60;&#x6a;&#100;&#x65;&#x6d;&#111;&#x75;&#x74;&#x68;&#x40;&#110;&#x76;&#105;&#100;&#105;&#97;&#46;&#x63;&#x6f;&#x6d;">&#60;&#x6a;&#100;&#x65;&#x6d;&#111;&#x75;&#x74;&#x68;&#x40;&#110;&#x76;&#105;&#100;&#105;&#97;&#46;&#x63;&#x6f;&#x6d;</a>&gt;çš„é‚®ä»¶å¾€æ¥</h3><h4 id="æˆ‘æ„šè ¢çš„é—®é¢˜"><a href="#æˆ‘æ„šè ¢çš„é—®é¢˜" class="headerlink" title="æˆ‘æ„šè ¢çš„é—®é¢˜"></a>æˆ‘æ„šè ¢çš„é—®é¢˜</h4><p>Hi Julien<br>Sorry to bother you. I am an intern in devtech team. I have seen your email about LDGDEPBAR with LDGSTS.  I have a question about it.<br>Can LDGSTS bands to a certain gmem barrierï¼ŸFor example, I want to do a prefetch on smem. In a for cycle, can i issue a set of LDGSTS for variable A and LDS variable B.  Then i sync LDGSTS for A. next loop i issue a set of LDGSTS for B and then LDS A. THEN I sync LDGSTS for B. then run this two loop many times.<br>is this possible by using inlinePTXï¼Ÿ<br>I will really appreciate if you can answer my question.<br>thanks a lot. </p>
<blockquote>
<p>è¿™é‡Œæˆ‘æƒ³åšä¸€ä¸ªSMEMçš„prefetchï¼Œåœ¨å½“å‰å¾ªç¯æ­¥ä½¿ç”¨LDGSTSä»GMEMä¸­é¢„å…ˆå¼‚æ­¥è¯»å–ä¸‹ä¸€ä¸ªå¾ªç¯æ­¥è¦ä½¿ç”¨åˆ°çš„æ•°æ®åˆ°SMEMã€‚è€Œå½“å‰å¾ªç¯æ­¥ä½¿ç”¨LDSä»SMEMä¸­è¯»å–ä¸Šä¸€å¾ªç¯é¢„è¯»çš„æ•°æ®ã€‚</p>
</blockquote>
<h4 id="å¤§ä½¬çš„å›ç­”"><a href="#å¤§ä½¬çš„å›ç­”" class="headerlink" title="å¤§ä½¬çš„å›ç­”"></a>å¤§ä½¬çš„å›ç­”</h4><p>Hi Jiang,</p>
<p>You are not bothering me ğŸ˜Š. I hope you enjoy your internship with NVIDIA and the Devtech team.</p>
<p>Say you have two LDGSTS for A and two LDGSTS for B and you want to alternate between both:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>  LDGSTS A0 <span class="comment">// write to shared memory</span></span><br><span class="line"><span class="number">2</span>  LDGSTS A1 <span class="comment">// write to shared memory â€“ you have to make sure thatâ€™s a different region from A0</span></span><br><span class="line"><span class="number">3</span>  LDGDEPBAR </span><br><span class="line"><span class="number">4</span> </span><br><span class="line"><span class="number">5</span>  LDS B0 <span class="comment">// load from shared memory â€“ that buffer must have been filled earlier</span></span><br><span class="line"><span class="number">6</span>  LDS B1</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span>  DEPBAR <span class="number">0</span> <span class="comment">// make sure the instructions before the LAST LDGDEPBAR have completed =&gt; A0/A1 are in shared memory</span></span><br><span class="line"><span class="number">9</span>  BAR.SYNC <span class="comment">// __syncthreads</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> LDGSTS B2 <span class="comment">// trigger the next LDGSTS for B â€“ you can reuse the same memory buffer than the one for B0</span></span><br><span class="line"><span class="number">12</span> LDGSTS B3</span><br><span class="line"><span class="number">13</span> LDGDEPBAR </span><br><span class="line"><span class="number">14</span>  </span><br><span class="line"><span class="number">15</span> LDS A0 </span><br><span class="line"><span class="number">16</span> LDS A1</span><br><span class="line"><span class="number">17</span> </span><br><span class="line"><span class="number">18</span> DEPBAR <span class="number">0</span> </span><br><span class="line"><span class="number">19</span> BAR.SYNC <span class="comment">// __syncthreads</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç ï¼ŒLine 2 ç‰¹æ„å‘ŠçŸ¥æˆ‘ â€œyou have to make sure thatâ€™s a different region from A0â€ æ˜¯ç”±äºåŒä¸€ä¸ª cp.async_group ä¸­çš„ cp.saync æ“ä½œçš„å…ˆåé¡ºåºæ˜¯æ²¡æœ‰ä¿è¯çš„ï¼Œå› æ­¤å¯¹åŒä¸€åœ°å€çš„æ‹·è´ä¼šå¯¼è‡´æœªå®šä¹‰çš„ç»“æœã€‚<br>&emsp;&emsp;Line 3 æ˜¯cp.async.commit_groupï¼Œåˆ›å»ºä¸€ä¸ªcp.async_groupå°†å‰ä¸¤ä¸ªLDGSTSåŒ…å«åœ¨å†…ã€‚åˆ°æ­¤ä¸ºæ­¢çš„ä¸‰è¡Œå‘èµ·äº†ä»GMEMåˆ°SMEMçš„å¼‚æ­¥æ‹·è´æ“ä½œï¼Œå¹¶å°†å…¶å½’çº³åˆ°äº†åŒä¸€ä¸ªcp.async_groupã€‚<br>&emsp;&emsp;Line 5 &amp; 6 ä½¿ç”¨LDSä»SMEMä¸­è¯»å–ä¸Šä¸€å¾ªç¯ä¸­å‡†å¤‡å¥½çš„æ•°æ®ã€‚<br>&emsp;&emsp;Line 8 ä¸ºcp.async.wait_group 0; ç­‰å¾…ç›´åˆ°è¿˜å‰©ä¸‹0ä¸ªcp.async_groupæœªå®Œæˆï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…æ‰€æœ‰cp.async_groupå®Œæˆã€‚è¿™é‡Œä¸ºç¡®ä¿A0ã€A1æ•°æ®å‡†å¤‡å°±ç»ªã€‚<br>&emsp;&emsp;BAR.SYNC ä¸º__syncthreads()ï¼ŒåŒæ­¥blockå†…æ‰€æœ‰çº¿ç¨‹ã€‚ï¼ˆä»SMEMä¸­è¯»å–æ•°æ®å¿…é¡»ä¿è¯åŒæ­¥ï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹éƒ½å·²ç»è¯»å–å®Œæ¯•ï¼‰<br>&emsp;&emsp;åç»­æ“ä½œé‡å¤è¿™ä¸€è¿‡ç¨‹ï¼ŒåŒºåˆ«æ˜¯äº¤æ¢äº†é¢„è¯»ä½¿ç”¨çš„ä¸å½“å‰è¯»å–çš„SMEM bufferã€‚å³ä¸ºä¸Šä¸€å¾ªç¯é¢„è¯»æ•°æ®å­˜å…¥A0ã€A1ï¼Œä½¿ç”¨B0ã€B1å·²ç»è¯»å¥½çš„æ•°æ®ã€‚ä¸‹ä¸€å¾ªç¯é¢„è¯»æ•°æ®å­˜å…¥B0ã€B1ï¼Œä½¿ç”¨A0ã€A1å·²ç»è¯»å¥½çš„æ•°æ®ã€‚ä»¥æ­¤è¾¾åˆ°éšè—è®¿å­˜å»¶è¿Ÿçš„æ•ˆæœã€‚</p>
</blockquote>
<p>This code does the trick. </p>
<p>That said if you have enough shared memory you can do smarter things:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>  LDGSTS A0</span><br><span class="line"><span class="number">2</span>  LDGSTS A1</span><br><span class="line"><span class="number">3</span>  LDGDEPBAR </span><br><span class="line"><span class="number">4</span> </span><br><span class="line"><span class="number">5</span>  LDGSTS B2 <span class="comment">// It must write to a different buffer in shared memory than the one used for B0/B1</span></span><br><span class="line"><span class="number">6</span>  LDGSTS B3</span><br><span class="line"><span class="number">7</span>  LDGDEPBAR </span><br><span class="line"><span class="number">8</span> </span><br><span class="line"><span class="number">9</span>  LDS B0</span><br><span class="line"><span class="number">10</span> LDS B1</span><br><span class="line"><span class="number">11</span> </span><br><span class="line"><span class="number">12</span> DEPBAR <span class="number">1</span> <span class="comment">// The LDGSTS B2/B3 can still be in flight</span></span><br><span class="line"><span class="number">13</span> BAR.SYNC <span class="comment">// __syncthreads</span></span><br><span class="line"><span class="number">14</span> </span><br><span class="line"><span class="number">15</span> LDGSTS A2 <span class="comment">// It must write to a different buffer in shared memory than the one used for A0/A1 â€“ shared memory for B0/B1?</span></span><br><span class="line"><span class="number">16</span> LDGSTS A3</span><br><span class="line"><span class="number">17</span> LDGDEPBAR </span><br><span class="line"><span class="number">18</span> </span><br><span class="line"><span class="number">19</span> LDS A0</span><br><span class="line"><span class="number">20</span> LDS A1</span><br><span class="line"><span class="number">21</span>  </span><br><span class="line"><span class="number">22</span> DEPBAR <span class="number">1</span> <span class="comment">// A2/A3 can still be in flight </span></span><br><span class="line"><span class="number">23</span> BAR.SYNC <span class="comment">// __syncthreads</span></span><br></pre></td></tr></table></figure>
<p>I hope it makes sense. If not, do not hesitate to ask questions.</p>
<blockquote>
<p>&emsp;&emsp;å†æ¥çœ‹ä¸€ä¸‹è¿™æ®µä»£ç ï¼Œå¤§ä½“ä¸ŠåŸºæœ¬ç›¸ä¼¼ã€‚Line 3ã€7åˆ†åˆ«åˆ›å»ºäº†ä¸¤ä¸ªcp.async-groupï¼ŒLine 3åŒ…å«äº†Line 1ã€2çš„å¼‚æ­¥æ‹·è´æ“ä½œï¼Œè€ŒLine 7åˆ™åŒ…å«Line 5ã€6çš„å¼‚æ­¥æ‹·è´ã€‚éšåLDSä»SMEMä¸­B0ã€B1åœ°å€è¯»å–åœ¨ä¹‹å‰å·²ç»å‡†å¤‡å¥½çš„æ•°æ®ã€‚<br>&emsp;&emsp;Line 12 DEPBAR 1;æŒ‡å®šçº¿ç¨‹ç­‰å¾…ç›´åˆ°ä»…å‰©ä¸€ä¸ªcp.async-groupï¼Œè¿™é‡Œåªæœ‰ä¸¤ä¸ªï¼Œä¸ºç­‰å¾…A0ã€A1è®¿å­˜ç»“æŸã€‚æ­¤æ—¶B2ã€B3è¿˜åœ¨ä¼ è¾“ä¸­ã€‚<br>&emsp;&emsp;Line 17åˆåˆ›å»ºäº†ä¸€ä¸ªcp.async-groupï¼ŒåŒ…å«äº†Line 15ã€16çš„å¼‚æ­¥æ‹·è´æ“ä½œã€‚<br>&emsp;&emsp;ç”±äºA0ã€A1æ•°æ®å·²ç»å‡†å¤‡å°±ç»ªï¼Œå› æ­¤å¯ç›´æ¥LDSè®¿é—®A0ã€A1ã€‚<br>&emsp;&emsp;æ‰§è¡Œåˆ°Line 22æ—¶ï¼ŒåŒæ ·æŒ‡å®šçº¿ç¨‹ç­‰å¾…ç›´åˆ°ä»…å‰©ä¸€ä¸ªcp.async-groupï¼Œæ­¤æ—¶ä»…å‰©2ä¸ªcp.async-groupä»åœ¨æ‰§è¡Œï¼Œå³ä¸ºç­‰å¾…B2ã€B3æ•°æ®æ‹·è´ç»“æŸã€‚</p>
</blockquote>
<p>è¡¥å……ä¸€ä¸‹åç»­å…¶ä»–æ“ä½œï¼Œè¿™ç§æ”¹åŠ¨ç›¸å½“äºæ˜¯ä½¿ç”¨æ›´å¤šçš„SMEMï¼Œå°†æ¯æ¬¡LDGSTSä¸­é—´ç©¿æ’ä¸¤æ¬¡LDSï¼Œå¢å¤§å‘èµ·ä»GMEMä¸­å–å›æ•°æ®çš„å¼‚æ­¥æ‹·è´æ“ä½œä¸LDSä¹‹é—´çš„æ—¶é—´é—´éš”(é—´éš”ä¸¤ä¸ªå¾ªç¯æ­¥çš„prefetch)ï¼Œæ›´å¥½åœ°éšè—è®¿å­˜å»¶è¿Ÿã€‚<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>  LDGSTS A0</span><br><span class="line"><span class="number">2</span>  LDGSTS A1</span><br><span class="line"><span class="number">3</span>  LDGDEPBAR </span><br><span class="line"><span class="number">4</span> </span><br><span class="line"><span class="number">5</span>  LDGSTS B2 <span class="comment">// It must write to a different buffer in shared memory than the one used for B0/B1</span></span><br><span class="line"><span class="number">6</span>  LDGSTS B3</span><br><span class="line"><span class="number">7</span>  LDGDEPBAR </span><br><span class="line"><span class="number">8</span>  <span class="comment">// A0 A1 B2 B3 PENDING B0 B1 READY</span></span><br><span class="line"><span class="number">9</span>  LDS B0</span><br><span class="line"><span class="number">10</span> LDS B1</span><br><span class="line"><span class="number">11</span> </span><br><span class="line"><span class="number">12</span> DEPBAR <span class="number">1</span> <span class="comment">// The LDGSTS B2/B3 can still be in flight</span></span><br><span class="line"><span class="number">13</span> BAR.SYNC <span class="comment">// __syncthreads</span></span><br><span class="line"><span class="number">14</span> <span class="comment">// B2 B3 PENDING B0 B1 A0 A1 READY</span></span><br><span class="line"><span class="number">15</span> LDGSTS A2 <span class="comment">// It must write to a different buffer in shared memory than the one used for A0/A1 â€“ shared memory for B0/B1?</span></span><br><span class="line"><span class="number">16</span> LDGSTS A3</span><br><span class="line"><span class="number">17</span> LDGDEPBAR </span><br><span class="line"><span class="number">18</span> <span class="comment">// B2 B3 A2 A3 PENDING B0 B1 A0 A1 READY</span></span><br><span class="line"><span class="number">19</span> LDS A0</span><br><span class="line"><span class="number">20</span> LDS A1</span><br><span class="line"><span class="number">21</span>  </span><br><span class="line"><span class="number">22</span> DEPBAR <span class="number">1</span> <span class="comment">// A2/A3 can still be in flight </span></span><br><span class="line"><span class="number">23</span> BAR.SYNC <span class="comment">// __syncthreads</span></span><br><span class="line"><span class="number">24</span> <span class="comment">// A2 A3 PENDING B0 B1 A0 A1 B2 B3 READY</span></span><br><span class="line"><span class="number">25</span> LDGSTS B0</span><br><span class="line"><span class="number">26</span> LDGSTS B1</span><br><span class="line"><span class="number">27</span> LDGDEPBAR</span><br><span class="line"><span class="number">28</span> <span class="comment">// A2 A3 B0 B1 PENDING A0 A1 B2 B3 READY</span></span><br><span class="line"><span class="number">29</span> LDS B2</span><br><span class="line"><span class="number">30</span> LDS B3</span><br><span class="line"><span class="number">31</span> </span><br><span class="line"><span class="number">32</span> DEPBAR <span class="number">1</span> </span><br><span class="line"><span class="number">33</span> BAR.SYNC</span><br><span class="line"><span class="number">34</span> <span class="comment">// B0 B1 PENDING A0 A1 B2 B3 A2 A3 READY</span></span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/20/cuda-4/" rel="prev" title="CUDAå­¦ä¹ éšè®°4 Voltaâ€™s Independent Thread Scheduling">
      <i class="fa fa-chevron-left"></i> CUDAå­¦ä¹ éšè®°4 Voltaâ€™s Independent Thread Scheduling
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/02/23/cuda-6/" rel="next" title="CUDAå­¦ä¹ éšè®°6 C++11ä¸­çš„å†…å­˜æ¨¡å‹ std::memory_order">
      CUDAå­¦ä¹ éšè®°6 C++11ä¸­çš„å†…å­˜æ¨¡å‹ std::memory_order <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CUDA%E5%AD%A6%E4%B9%A0%E9%9A%8F%E8%AE%B05-Asynchronous-copy-cp-async"><span class="nav-number">1.</span> <span class="nav-text">CUDAå­¦ä¹ éšè®°5 Asynchronous copy cp.async</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cp-async"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">cp.async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cp-async-commit-group"><span class="nav-number">1.0.0.2.</span> <span class="nav-text">cp.async.commit_group</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cp-async-wait-group-cp-async-wait-all"><span class="nav-number">1.0.0.3.</span> <span class="nav-text">cp.async.wait_group&#x2F;cp.async.wait_all</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8EJulien-Demouth-60-x6a-100-x65-x6d-111-x75-x74-x68-x40-110-x76-105-100-105-97-46-x63-x6f-x6d-gt-%E7%9A%84%E9%82%AE%E4%BB%B6%E5%BE%80%E6%9D%A5"><span class="nav-number">1.0.1.</span> <span class="nav-text">ä¸Julien Demouth &lt;jdemouth@nvidia.com&gt;çš„é‚®ä»¶å¾€æ¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%91%E6%84%9A%E8%A0%A2%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.0.1.1.</span> <span class="nav-text">æˆ‘æ„šè ¢çš„é—®é¢˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%A7%E4%BD%AC%E7%9A%84%E5%9B%9E%E7%AD%94"><span class="nav-number">1.0.1.2.</span> <span class="nav-text">å¤§ä½¬çš„å›ç­”</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jiang Shao"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Jiang Shao</p>
  <div class="site-description" itemprop="description">WeChat: shaojiang9650<br>Email: shao_study@163.com</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiang Shao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
